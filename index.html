<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grade de Canais - Seja Fibra</title>

  <!-- Bootstrap e ícones -->
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/sejafibra/agenda/refs/heads/main/faviconsf.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --brand-blue: #0d6efd;
      --brand-orange: #ff7a00;
      --accent-bg: #f8f9fa;
      --muted: #6c757d;
    }
    body { background: var(--accent-bg); font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .logo { height:50px; }
    .card { border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,.06); }
    .nav-pills .nav-link.active { background: linear-gradient(90deg,var(--brand-blue), #0062cc); color:#fff; }
    .table thead th { background: linear-gradient(90deg, #e9f2ff, #fff); }
    .manutencao { background: #fff7c2 !important; }
    .small-muted { color:var(--muted); font-size:0.9rem; }

    /* A4 fixo em pixels (96dpi -> 794x1122px) */
    .a4page {
      width: 794px;
      height: 1122px;
      padding: 40px;
      box-sizing: border-box;
      background: #fff;
      overflow: hidden;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .a4-title { font-size:18px; font-weight:600; margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="container-fluid mt-3">
    <div class="row justify-content-center mb-2">
      <div class="col-md-10 d-flex align-items-center">
        <img src="https://sejafibra.net/wp-content/uploads/2023/06/logonovofibra.png" class="logo me-3" alt="logo">
        <div>
          <h4 style="margin:0">Painel Canais - Fibra Play</h4>
          <div class="small-muted">Controle interno • Não compartilhar essa página</div>
        </div>
        <div class="ms-auto">
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm" style="display:none"><i class="bi bi-box-arrow-right"></i> Sair</button>
        </div>
      </div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="row justify-content-center">
      <div class="col-md-4">
        <div class="card p-3">
          <div class="card-body">
            <h5 class="card-title text-center">Login</h5>
            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Senha</label>
                <input id="password" type="password" class="form-control" required />
              </div>
              <button class="btn btn-primary w-100" type="submit">Entrar</button>
            </form>
            <div class="small-muted text-center mt-2">Somente usuários autorizados podem marcar manutenção</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conteúdo -->
    <div id="app" style="display:none;">
      <div class="row justify-content-center">
        <div class="col-md-10">
          <ul class="nav nav-pills mb-3" id="tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#comparativo">Comparativo</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#fibraplay">Fibra Play</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#basico">Fibra Play Básico</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#premium">Fibra Play Premium</button></li>
          </ul>

          <div class="tab-content">
            <!-- Comparativo -->
            <div class="tab-pane fade show active" id="comparativo">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Comparativo de Canais</h5></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="comparativoTable">
                      <thead>
                        <tr>
                          <th>Nº</th>
                          <th>Nome</th>
                          <th>Fibra Play Cortesia</th>
                          <th>Fibra Play Básico</th>
                          <th>Fibra Play Premium</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="comparativoBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fibra Play -->
            <div class="tab-pane fade" id="fibraplay">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <h5 class="mb-0">Fibra Play</h5>
                  <div class="ms-auto"><button id="exportFibraPlay" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-pdf"></i> Exportar em PDF</button></div>
                </div>
                <div class="card-body"><div id="fibraPlayList" class="list-group"></div></div>
              </div>
            </div>

            <!-- Básico -->
            <div class="tab-pane fade" id="basico">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <h5 class="mb-0">Fibra Play Básico</h5>
                  <div class="ms-auto"><button id="exportBasico" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-pdf"></i> Exportar em PDF</button></div>
                </div>
                <div class="card-body"><div id="basicoList" class="list-group"></div></div>
              </div>
            </div>

            <!-- Premium -->
            <div class="tab-pane fade" id="premium">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <h5 class="mb-0">Fibra Play Premium</h5>
                  <div class="ms-auto"><button id="exportPremium" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-pdf"></i> Exportar em PDF</button></div>
                </div>
                <div class="card-body"><div id="premiumList" class="list-group"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3 mb-5">
      <div class="col-md-10 text-center small-muted"><small>No caso de inconsistências, informe no grupo Headend</small></div>
    </div>
  </div>

<script>
/* =========================
   CONFIG FIREBASE
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDS9VJ9BnL1s77x33hy9dMG3k0HNBSj_1g",
  authDomain: "canais-35cb2.firebaseapp.com",
  projectId: "canais-35cb2",
  storageBucket: "canais-35cb2.firebasestorage.app",
  messagingSenderId: "1009365394727",
  appId: "1:1009365394727:web:024a579975bd5a6b443502",
  databaseURL: "https://canais-35cb2-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const autorizados = ["bioranss@gmail.com","claudir@sejafibra.net","eduardo@sejafibra.net","junior@sejafibra.net"];
let canaisData = {};
let currentUserEmail = null;

const loginCard = document.getElementById('loginCard');
const loginForm = document.getElementById('loginForm');
const app = document.getElementById('app');
const comparativoBody = document.getElementById('comparativoBody');
const fibraPlayList = document.getElementById('fibraPlayList');
const basicoList = document.getElementById('basicoList');
const premiumList = document.getElementById('premiumList');
const logoutBtn = document.getElementById('logoutBtn');

function safeBool(v){ return v===true || v==='true' || v===1 || v==='1'; }
function formatNum(n){ return n===undefined || n===null ? '' : String(n); }

/* =========================
   RENDER COM PLANOS EDITÁVEIS
   ========================= */
function renderComparativo(){
  comparativoBody.innerHTML = '';
  const arr = Object.entries(canaisData)
    .map(([id,c])=>({...c,_id:id}))
    .sort((a,b)=>(parseInt(a.numero)||0)-(parseInt(b.numero)||0));

  arr.forEach(c=>{
    const tr = document.createElement('tr');
    if(safeBool(c.manutencao)) tr.classList.add('manutencao');

    tr.innerHTML = `
      <td>${formatNum(c.numero)}</td>
      <td><strong>${c.nome||''}</strong></td>`;

    ["fibraPlay","fibraPlayBasico","fibraPlayPremium"].forEach(plan=>{
      const td = document.createElement('td');
      const val = safeBool(c[plan]);
      const span = document.createElement('span');
      span.textContent = val ? "✔" : "X";
      span.style.color = val ? "green" : "red";
      span.style.fontWeight = "bold";

      if(currentUserEmail && autorizados.includes(currentUserEmail.toLowerCase())){
        span.style.cursor = "pointer";
        span.title = "Clique para alternar";
        span.onclick = ()=> togglePlan(c._id, plan, !val);
      }

      td.appendChild(span);
      tr.appendChild(td);
    });

    const manutTd = document.createElement('td');
    const badge = document.createElement('span');
    badge.textContent = safeBool(c.manutencao) ? 'Em manutenção' : 'OK';
    badge.className = safeBool(c.manutencao) ? 'badge bg-warning text-dark' : 'badge bg-success';
    manutTd.appendChild(badge);

    if(currentUserEmail && autorizados.includes(currentUserEmail.toLowerCase())){
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm btn-outline-secondary ms-2';
      btn.innerHTML = '<i class="bi bi-tools"></i>';
      btn.onclick = ()=>toggleManutencao(c._id);
      manutTd.appendChild(btn);
    }

    tr.appendChild(manutTd);
    comparativoBody.appendChild(tr);
  });
}

/* =========================
   TOGGLE PLAN
   ========================= */
function togglePlan(id, plan, newValue){
  if(!currentUserEmail) return alert("Faça login");
  if(!autorizados.includes(currentUserEmail.toLowerCase())) return alert("Não autorizado");
  db.ref('canais/'+id).update({ [plan]: newValue });
}

/* =========================
   LISTAS
   ========================= */
function renderPlanLists(){
  fibraPlayList.innerHTML = basicoList.innerHTML = premiumList.innerHTML = '';
  const arr = Object.entries(canaisData).map(([id,c])=>({...c})).sort((a,b)=>(parseInt(a.numero)||0)-(parseInt(b.numero)||0));
  arr.forEach(c=>{
    const line = document.createElement('div');
    line.className = 'list-group-item d-flex justify-content-between align-items-center';
    if(safeBool(c.manutencao)) line.classList.add('manutencao');
    line.innerHTML = `<div style="width:100%"><strong>${c.numero||''}</strong> - ${c.nome||''}</div>`;
    if(safeBool(c.fibraPlay)) fibraPlayList.appendChild(line.cloneNode(true));
    if(safeBool(c.fibraPlayBasico)) basicoList.appendChild(line.cloneNode(true));
    if(safeBool(c.fibraPlayPremium)) premiumList.appendChild(line.cloneNode(true));
  });
}

/* =========================
   MANUTENÇÃO
   ========================= */
function toggleManutencao(id){
  if(!currentUserEmail) return alert("Faça login");
  if(!autorizados.includes(currentUserEmail.toLowerCase())) return alert("Não autorizado");
  const atual = canaisData[id] || {};
  db.ref('canais/'+id).update({manutencao:!safeBool(atual.manutencao), manutencaoBy:!safeBool(atual.manutencao)?currentUserEmail:""});
}

/* =========================
   EXPORT PDF
   ========================= */
function exportPlanToPDF(planName, containerElement){
  const page = document.createElement('div');
  page.className = 'a4page';

  const logo = document.createElement('img');
  logo.src = "https://sejafibra.net/wp-content/uploads/2023/06/logonovofibra.png";
  logo.style.height = "40px";
  logo.style.display = "block";
  logo.style.margin = "0 auto 10px auto";
  page.appendChild(logo);

  const title = document.createElement('div');
  title.className = 'a4-title';
  title.style.textAlign = "center";
  title.textContent = `${planName} — Lista de Canais`;
  page.appendChild(title);

  const dateLine = document.createElement('div');
  dateLine.className = 'small-muted';
  dateLine.style.textAlign = "center";
  dateLine.textContent = 'Gerado em: ' + new Date().toLocaleString('pt-BR');
  page.appendChild(dateLine);

  page.appendChild(document.createElement('hr'));

  const colContainer = document.createElement('div');
  colContainer.style.width = "680px";
  colContainer.style.margin = "0 auto";
  colContainer.style.columnCount = 4;
  colContainer.style.columnGap = "20px";
  colContainer.style.fontSize = "10px";
  colContainer.style.lineHeight = "1.2";
  colContainer.style.textAlign = "left";

  const items = Array.from(containerElement.querySelectorAll('.list-group-item')).map(n => n.innerText.trim());
  items.forEach(txt=>{
    const div = document.createElement('div');
    div.textContent = txt;
    div.style.breakInside = "avoid";
    div.style.marginBottom = "2px";
    colContainer.appendChild(div);
  });

  page.appendChild(colContainer);

  const opt = {
    margin: [0,0,0,0],
    filename: `${planName.replace(/\s+/g,'_')}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'px', format: [794,1122], orientation: 'portrait' }
  };

  html2pdf().set(opt).from(page).save();
}

/* =========================
   DB LISTENER
   ========================= */
function listenCanais(){
  db.ref('canais').on('value',snap=>{
    canaisData = snap.val()||{};
    renderComparativo();
    renderPlanLists();
  });
}

/* =========================
   AUTH
   ========================= */
loginForm.addEventListener('submit',e=>{
  e.preventDefault();
  auth.signInWithEmailAndPassword(email.value,password.value).catch(err=>alert(err.message));
});
auth.onAuthStateChanged(u=>{
  if(u){
    currentUserEmail = u.email.toLowerCase();
    loginCard.style.display="none"; app.style.display="block"; logoutBtn.style.display="inline-block";
    listenCanais();
  } else {
    currentUserEmail=null;
    loginCard.style.display="block"; app.style.display="none"; logoutBtn.style.display="none";
  }
});
logoutBtn.onclick=()=>auth.signOut();

document.getElementById('exportFibraPlay').onclick=()=>exportPlanToPDF('Fibra Play',fibraPlayList);
document.getElementById('exportBasico').onclick=()=>exportPlanToPDF('Fibra Play Básico',basicoList);
document.getElementById('exportPremium').onclick=()=>exportPlanToPDF('Fibra Play Premium',premiumList);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
